#!@SHELL@
# @configure_input@              -*- shell-script -*-
# Profiling script for @PACKAGE@ test suite and apps.
# INTEL CONFIDENTIAL - For Intel Internal Use Only

set -e

D=`cd @abs_top_builddir@ && pwd`
S=`cd @abs_top_srcdir@ && pwd`

GPROF=@GPROF@
test -z ${GPROF} && echo "need to install gprof." && exit 1
CXXFILT=@CXXFILT@
test -z ${CXXFILT} && echo "need to install c++filt." && exit 1

FIND=`which find` 2>/dev/null
test -z ${FIND} && echo "need to install find." && exit 1
MKDIR=`which mkdir` 2>/dev/null
test -z ${MKDIR} && echo "need to install mkdir." && exit 1
MV=`which mv` 2>/dev/null
test -z ${MV} && echo "need to install mv." && exit 1
RM=`which rm` 2>/dev/null
test -z ${RM} && echo "need to install rm." && exit 1


for x in "$D/tests/unit/bat/gmon.out" \
         "$D/tests/unit/bat/.libs/gmon.out" 
do
   test -f "$x" && ${RM} -f "$x"
done

test -d "$D/tests/gprof/bat" || ${MKDIR} -p "$D/tests/gprof/bat"

cd "$D/tests/unit/bat/.libs"
 
LD_LIBRARY_PATH="$D/aas/OSAL/.libs:$D/aas/AASLib/.libs" ./bat ${1+"$@"} >/dev/null 2>&1

${GPROF} --demangle \
         --flat-profile \
         --display-unused-functions \
         --no-annotated-source \
         --no-graph \
         --no-exec-counts \
         bat gmon.out >"$D/tests/gprof/bat/flat-profile"

${GPROF} --demangle \
         --no-flat-profile \
         --no-annotated-source \
         --graph \
         --no-exec-counts \
         bat gmon.out >"$D/tests/gprof/bat/graph"

${GPROF} --demangle \
         --no-flat-profile \
         --no-annotated-source \
         --no-graph \
         --exec-counts \
         bat gmon.out >exec-counts

${CXXFILT} <"$D/tests/unit/bat/.libs/exec-counts" >"$D/tests/gprof/bat/exec-counts"

${GPROF} --demangle \
         --no-flat-profile \
         --annotated-source \
         --separate-files \
         --directory-path="$S/include/aalsdk:$S/tests/unit/bat" \
         --no-graph \
         --no-exec-counts \
         bat gmon.out

for x in `${FIND} "$S/include/aalsdk" -printf "%f "`
do
   test -f "${x}-ann" && ${MV} "${x}-ann" "$D/tests/gprof/bat"
done

# for x in `${FIND} "$S/lib" -printf "%f "`
# do
#    test -f "${x}-ann" && ${MV} "${x}-ann" "$D/tests/gprof/bat"
# done

for x in `${FIND} "$S/tests/unit/bat" -printf "%f "`
do
   test -f "${x}-ann" && ${MV} "${x}-ann" "$D/tests/gprof/bat"
done

exit 0
